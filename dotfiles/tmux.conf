################################################################################
#                                                                              #
# ENVIRONMENT DETECTION                                                        #
#                                                                              #
# Set some variables based on the os / terminal running.                       #
#                                                                              #
################################################################################

# if enterprise linux family ($DISTRO set in ~/.shell/exports)
if-shell 'if [[ "`echo $DISTRO`" = "entlinux" ]]; then true; else false; fi' \
  'TMUX_COPY_COMMAND="xclip"'

# if debian linux family ($DISTRO set in ~/.shell/exports)
if-shell 'if [[ "`echo $DISTRO`" = "deblinux" ]]; then true; else false; fi' \
  'TMUX_COPY_COMMAND="xclip"'

# if osx ($DISTRO set in ~/.shell/exports)
if-shell 'if [[ "`echo $DISTRO`" = "osx" ]]; then true; else false; fi' \
  'TMUX_COPY_COMMAND="reattach-to-user-namespace pbcopy"'

################################################################################
#                                                                              #
# GENERAL CONFIGS                                                              #
#                                                                              #
################################################################################

# stop printing gibberish at the end of mouse drag due to lack of
# mouse utf8 support in gnome terminal https://github.com/tmux/tmux/issues/816
set-option -g set-clipboard off

# dont wait for escape key as part of a key sequence
set -sg escape-time 0

################################################################################
#                                                                              #
# BINDINGS                                                                     #
#                                                                              #
################################################################################

# remap prefix
unbind-key C-b
set -g prefix C-Space
bind-key Space send-prefix

# use shift-arrow keys (left and right) to rotate panes
bind-key -n S-Right select-pane -t :.+
bind-key -n S-Left select-pane -t :.-

# use shift-arrow keys (up and down) to rotate windows
bind-key -n S-Up next-window
bind-key -n S-Down previous-window

# use vi navigation and search in scroll mode ctrl-b [
setw -g mode-keys vi
set -g status-keys vi
bind-key -T edit-mode-vi Up send-keys -X history-up
bind-key -T edit-mode-vi Down send-keys -X history-down

# pre-defined sessions ctrl-b [N]
bind-key A source-file ~/.tmux/administration
bind-key D source-file ~/.tmux/development
bind-key L source-file ~/.tmux/logs
bind-key G source-file ~/.tmux/gifcast
bind-key W source-file ~/.tmux/work

# rebind splits so that they open with the same dir
bind '"' split-window -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

# balance splits
unbind-key h
unbind-key v
bind-key h select-layout even-horizontal
bind-key v select-layout even-vertical

# create new session
bind-key C new-session

################################################################################
#                                                                              #
#  COLORS                                                                      #
#                                                                              #
#  Use hex values in quotes or colourNNN, for values run the command:          #
#  `for i in {0..255} ;do printf "\x1b[38;5;${i}mcolour${i}\n"; done`          #
#                                                                              #
################################################################################

# set custom 256 color terminal with italics
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ',xterm-256color:Tc'

# theming
set -w -g window-status-current-style fg=colour1
set -g status-bg colour18
set -g status-fg colour245
set -g pane-border-style bg=default
set -g pane-active-border-style fg=colour1

################################################################################
#                                                                              #
#  MOUSE                                                                       #
#                                                                              #
#  Option + Mouse drag to use terminal native selection, else will enter       #
#  tmux copy mode.                                                             #
#                                                                              #
#  MOUSEDOWN1  --->  MouseDown1         MOUSEDRAG1     --->  MouseDrag1        #
#  MOUSEDOWN2  --->  MouseDown2         MOUSEDRAG2     --->  MouseDrag2        #
#  MOUSEDOWN3  --->  MouseDown3         MOUSEDRAG3     --->  MouseDrag3        #
#  MOUSEUP1    --->  MouseUp1           MOUSEDRAGEND1  --->  MouseDragEnd1     #
#  MOUSEUP2    --->  MouseUp2           MOUSEDRAGEND2  --->  MouseDragEnd2     #
#  MOUSEUP3    --->  MouseUp3           MOUSEDRAGEND3  --->  MouseDragEnd3     #
#  WHEELUP     --->  WheelUp            WHEELDOWN      --->  WheelDown         #
#                                                                              #
#  Each should be conbined with a suffix to id location, Pane, Status, etc.    #
#                                                                              #
################################################################################

# enable mouse for pane and window selection, pane resizing
set -g mouse on

# Restore pre-2.1 behavior of scrolling with the scrollwheel in Vim, less, copy
# mode etc, otherwise entering copy mode if not already in it.
#
#   if in copy mode (pane_in_mode) || using the mouse already (mouse_any_flag)
#     pass through mouse events to current pane (send -Mt=)
#   elsif in alternate screen mode
#     send `Up` key
#   else
#     enter copy mode (-e exits if we scroll to the bottom)
#   end

bind-key -T root WheelUpPane \
  if-shell -Ft= '#{?pane_in_mode,1,#{mouse_any_flag}}' \
    'send -Mt=' \
    'if-shell -Ft= "#{alternate_on}" "send -t= Up" "copy-mode -et="'
bind-key -T root WheelDownPane \
  if-shell -Ft = '#{?pane_in_mode,1,#{mouse_any_flag}}' \
    'send -Mt=' \
    'if-shell -Ft= "#{alternate_on}"  "send -t= Down" "send -Mt="'

# unbind all keys except scroll events
# unbind-key -t vi-copy MouseDown1Pane
# unbind-key -t vi-copy MouseDown1Pane
# unbind-key -t vi-copy MouseUp1Pane
# unbind-key -t vi-copy MouseDragEnd1Pane

# stay in copy mode on drag end, exit on escape
unbind-key -T copy-mode-vi MouseDragEnd1Pane
bind-key -T copy-mode-vi Escape send-keys -X cancel

# press y in copy mode to copy selection to clipboard
bind-key -T copy-mode-vi y send-keys -X copy-pipe $TMUX_COPY_COMMAND

# copy selected text at the end of a mouse click and drag selection
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe $TMUX_COPY_COMMAND

# unbind all double and tripple clicks
unbind-key -T copy-mode-vi DoubleClick1Pane
unbind-key -T copy-mode-vi TripleClick1Pane
unbind-key -T root DoubleClick1Pane
unbind-key -T root TripleClick1Pane
unbind-key -T copy-mode DoubleClick1Pane
unbind-key -T copy-mode TripleClick1Pane

# copy selected text after a double or triple click initiated while in vi copy mode
# use copy-pipe-and-cancel instead of copy-pipe if you want to exit after selection
bind-key -T copy-mode-vi DoubleClick1Pane send-keys -t{mouse} -X select-word\; send-keys -X copy-pipe $TMUX_COPY_COMMAND
bind-key -T copy-mode-vi TripleClick1Pane send-keys -t{mouse} -X select-line\; send-keys -X copy-pipe $TMUX_COPY_COMMAND

# do the same for double and triple clicks when not in vi copy mode
# use copy-pipe-and-cancel instead of copy-pipe if you want to exit after selection
bind-key -T root DoubleClick1Pane if-shell -Ft{mouse} '#{alternate_on}' "send-keys -M" "copy-mode -t{mouse}; send-keys -t{mouse} -X select-word; send-keys -t{mouse} -X copy-pipe \"$TMUX_COPY_COMMAND\""
bind-key -T root TripleClick1Pane if-shell -Ft{mouse} '#{alternate_on}' "send-keys -M" "copy-mode -t{mouse}; send-keys -t{mouse} -X select-line; send-keys -t{mouse} -X copy-pipe \"$TMUX_COPY_COMMAND\""

# middle click exit copy mode and paste, in normal mode paste
unbind-key -T root MouseUp2Pane
unbind-key -T copy-mode-vi MouseUp2Pane
bind-key -T root MouseUp2Pane paste-buffer
bind-key -T copy-mode-vi MouseUp2Pane send-keys -X cancel\; paste-buffer

# scroll 3 lines at a time instead of default 5; don't extend dragged selections
bind-key -T copy-mode-vi WheelUpPane select-pane\; send-keys -t{mouse} -X clear-selection\; send-keys -t{mouse} -X -N 3 scroll-up
bind-key -T copy-mode-vi WheelDownPane select-pane\; send-keys -t{mouse} -X clear-selection\; send-keys -t{mouse} -X -N 3 scroll-down

# word delimiters, second option is neccessary to append a ', default is ` -_@'.
set-window-option -g word-separators ' "=,()[]'
set-window-option -ag word-separators "'"

################################################################################
#                                                                              #
# WINDOWING                                                                    #
#                                                                              #
################################################################################

# automatically renumber window numbers on closing a pane (tmux >= 1.7)
set -g renumber-windows on

# start window and pane numbering at 1
set -g base-index 1
set -g pane-base-index 1

# dynamically update iTerm tab and window titles
 set -g set-titles on

# reload config file with ctrl-b r
bind-key r source-file ~/.tmux.conf

# toggle synchronize panes
bind-key S set-window-option synchronize-panes

# define the window title format
set -g set-titles-string "#T : #h > #S > #W"

# don't change tmux's own window titles
# set -w -g automatic-rename off

# send focus events through
set -g focus-events on

# show bells in window titles
set -g window-status-bell-style fg=yellow,bold,underscore

# set the window list format in status bar
set -g window-status-format "#I:#{window_panes} #W#F"
set -g window-status-current-format "#I:#{window_panes} #W#F"
set -g window-status-separator "  "

# flag activity in the window list
setw -g monitor-activity on
setw -g window-status-activity-style bg=colour18,fg=yellow,none

################################################################################
#                                                                              #
# STATUS BAR                                                                   #
#                                                                              #
################################################################################

# status bar left side
set-option -g status-left-length 100
set-option -g status-left ' #S   ⧉ #I/#{session_windows} ⊞ #P/#{window_panes}   '

# status bar right side
set-option -g status-right-length 100
# if you are running a version of osx prior to sierra you will need to change $3 to $2 in the awk below
set-option -g status-right "#([ `pmset -g batt | grep -c 'InternalBattery'` -gt 0 ] && pmset -g batt | awk 'NR==2 {gsub(/;/,\"\");print \"   \"$3}')   %H:%M #(date -u '+%%H:%%M %%d-%%b-%%y') "
